<div id="solver">

<!--   <div class="issue">
    <div class="flex-container">

      <div class="issue-title view"><h3><strong><%= @problem.title %></strong></h3>
      </div>


      <div class="right-buttons">
        <%if @problem.user.include?(@user)%>
          <%= link_to "Leave", unsponsor_problem_path(:problem_id => @problem.id), :method => "post", :class => "button"  %>
        <%else%>
          <%= link_to "Join", sponsor_problem_path(:problem_id => @problem.id), :method => "post", :class => "button"  %>
        <%end%>
      </div>

    </div>


    <% if @problem.goal %>
      <div class="proposal-activity-description">
        <i class="fas fa-link"></i>
        Attached to goal <strong><%= link_to @problem.title, goal_path(@problem.goal) %></strong>
      </div>
    <% end %>

    <div class="issue-info">
      <div>
        <i class="fas fa-handshake"></i>
        <%= @problem.user.count %> collaborators
      </div>
      <div>
        <i class="fas fa-clipboard-list"></i>
        <%= @problem.criterium.count %> criteria
      </div>
      <div>
        <i class="fas fa-comment-alt"></i> 
        <%= @problem.solution.count %> proposals
      </div>
      <div class="post-signature">
        <i class="fas fa-clock"></i>
        Created <%= time_ago_in_words(@problem.created_at) %> ago
        by
        <em><%= 
        begin 
          User.find(@problem.creator).name
        rescue 
        end  %></em>
      </div>
    </div>

    </div>

    <% if @problem.description.length > 0 %> 
      <p class="issue-description"><%= @problem.description.gsub(URI.regexp, '<a target="_blank" href="\0">\0</a>').html_safe %></p>
    <% end %> 

 -->
  <!-- DETAILS ENDS -->

 


<!-- Table -->

<div><h3>Table for 
  <%= link_to issue_path( :problem_id => @problem.hashid) do %>  
    <strong><%= @problem.title %></strong>
  <% end %>
</h3></div>

<p>Refresh page for current stats</p>

<!-- <br>
<div><%= link_to issue_path( :problem_id => @problem.hashid), :class => "button button-hollow" do %>  
  <i class="fas fa-list"></i> List view
<% end %>
</div><br> -->


<div class="outer-table">
<table class="proposal-grid" cellspacing ="2" cellpadding ="6">

<tr>
  <th class="table-hidden"></th>

  <% @solutions.each do |solution| %>
    <th class="table-title" colspan="2">
      <%= link_to solution_path(:solution_id => solution.hashid) do %>
        <div><%= solution.title %></div>
      <% end %>
    </th>
  <% end %>
</tr>

<tr>
  <th class="table-hidden"></th>
  <% @solutions.each do |solution| %>
    <th class="yes">Yes</th>
    <th class="no">No</th>
  <% end %>
</tr>

<% @all_criteria.each do |criterion| %>
  <tr>
    <td class="table-title">
      <%= link_to show_criterium_path(criterion.hashid) do %>
      <div><%= criterion.title %></div>
      <% end %>
    </td>

    <% @solutions.each do |solution| %>
      
      <% polls = criterion.poll.where(solution_id: solution.id) if criterion.poll.count > 0 %>

        <% if logged_in? %>
            
          <% 
            if criterion.poll.where(solution_id: solution.id).where(user_id: @user.id).count > 0
              poll_id = criterion.poll.where(solution_id: solution.id).where(user_id: @user.id).first.id
            else
              poll_id = "#{solution.id}-#{criterion.id}"
            end
            %>
          <% if current_user && criterion.poll.where(solution_id: solution.id).where(user_id: @user.id).where(answer: 1).count == 0 %>

            <td class="yes-score" id="<%= poll_id %>-yes">
              <%= link_to quiet_set_poll_path(:criterium_id => criterion.id, :solution_id => solution.id, :answer => 1), :method => "post", :class => 'yes-poll' do %>
                <div><%= polls.where(answer: 1).count if polls %></div>
              <% end %>
            </td>
          <% else %>
            <td class="yes-score answered" id="<%= poll_id %>-yes">
              <%= link_to quiet_set_poll_path(:criterium_id => criterion.id, :solution_id => solution.id, :answer => nil), :method => "post", :class => 'remove-poll' do %>
                <div><%= polls.where(answer: 1).count if polls %></div>
              <% end %>
            </td>
          <% end %>

          <% if current_user && criterion.poll.where(solution_id: solution.id).where(user_id: @user.id).where(answer: 0).count == 0 %>
            <td class="no-score" id="<%= poll_id %>-no">
              <%= link_to quiet_set_poll_path(:criterium_id => criterion.id, :solution_id => solution.id, :answer => 0), :method => "post", :class => 'no-poll' do %>
                <div><%= polls.where(answer: 0).count if polls %></div>
              <% end %>
            </td>
        <% else %>
            <td class="no-score answered" id="<%= poll_id %>-no">
              <%= link_to quiet_set_poll_path(:criterium_id => criterion.id, :solution_id => solution.id, :answer => nil), :method => "post", :class => 'remove-poll' do %>
                <div><%= polls.where(answer: 0).count if polls %></div>
              <% end %>
            </td>
        <% end %>
      
      <% else %>
      
        <td class="yes-score "><div><%= polls.where(answer: 1).count if polls %></div></td>
        <td class="no-score "><div><%= polls.where(answer: 0).count if polls %></div></td>

      <% end %>
    <% end %>
  </tr>
<% end %>

<tr>
  <th class="table-hidden">Poll tallies</th>
  <% @solutions.each do |solution| %>
    <td class="yes-score total "><div><strong><%= Poll.where(solution_id: solution.id).where(answer: 1).count %></strong></div></td>
    <td class="no-score total "><div><strong><%= Poll.where(solution_id: solution.id).where(answer: 0).count %></strong></div></td>
  <% end %>
</tr>

<% if (!@problem.scoring_method || @problem.scoring_method == 1) && false %>

  <tr>
    <th class="table-hidden">Weighted scores</th>
    <% @solutions.each do |solution| %>
      <% polls = Poll.where(solution_id: solution.id) if Poll.where(solution_id: solution.id) %>
      <th class="weighted" colspan="2"><%= solution.score if polls %> %</th>
    <% end %>
  </tr>

<% elsif @problem.scoring_method == 2 || true %>

  <tr>
    <th class="table-hidden">Distance from convergence</th>
    <% @solutions.each do |solution| %>
      <% polls = Poll.where(solution_id: solution.id) if Poll.where(solution_id: solution.id).count > 0 %>
      <th class="percentage" colspan="2"><%= 100 - (polls.average(:answer) * 100).round if polls %> %</th>
    <% end %>
  </tr>

<% elsif @problem.scoring_method == 3 %>

  <tr>
    <th class="table-hidden">Yes's/total</th>
    <% @solutions.each do |solution| %>
      <% polls = Poll.where(solution_id: solution.id) if Poll.where(solution_id: solution.id).count > 0 %>
      <th class="percentage" colspan="2"><%= (polls.average(:answer) * 100).round if polls %> %</th>
    <% end %>
  </tr>

<% end %>

</table>
</div>

<!-- TABLE -->

<%= render(:partial => 'discussions/discussion-mini', :locals => {:@discussion => @discussion}) if Setting.find(4).state && @problem.include_comments %>


</div>

<!-- <br><br><span>This is a "brainstorm". Checkout the <%= link_to "GUIDE", documentation_path %> for more info.</span> -->


<% if logged_in? && current_user.admin? %>
  <span class="admin-section">
    <br><br>
    Created by <%= @problem.creator %> â€“
    <%= link_to 'Remove', @problem, method: :delete, data: { confirm: 'Delete brainstorm?' } %>

    <% if @problem.post %>
        <%= link_to "Broadcast", broadcast_post_path(:post_id => @problem.post.id), :method => "post", :class => 'button', data: { confirm: "Broadcast post?" } %>
    <% end %>
  </span>
<% end %>

<script type="text/javascript">
  $(".yes-poll").click(function() {
    let oppositePollId = "#" + $(this).parent()[0].id.replace("yes", "no")
    $(oppositePollId).removeClass('answered')
    $(oppositePollId).find("a").removeClass('remove-poll').attr("href", $(oppositePollId).find("a").attr("href") + "&answer=0")

    $(this).parent().addClass('answered')
    $(this).addClass('answered-tentative')
  });

  $(".no-poll").click(function() {
    let oppositePollId = "#" + $(this).parent()[0].id.replace("no", "yes")
    $(oppositePollId).removeClass('answered')
    $(oppositePollId).find("a").removeClass('remove-poll').attr("href", $(oppositePollId).find("a").attr("href") + "&answer=1")

    $(this).parent().addClass('answered')
    $(this).addClass('answered-tentative')
  });

  $(".remove-poll").click(function() {
    console.log('hi')
    setTimeout(function () {
      location.reload()
    }, 10);
  });
</script>