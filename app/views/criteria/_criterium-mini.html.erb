<% if criterium.title %>

  <% @user = current_user %>
  <% status_color = "#ff7455d9;;" if criterium.user.include?(@user) %>
  <% status_color = "#05adabab;" if criterium.cridissent.find_by(user: @user) %>

  <div class="criterium" >

    <div class="criterium-top">
      <div class="criterium-title">
        <%= criterium.title %>

        <br>

        <div class="criterion-details">
          <!-- If anyone dissented -->
          <% if criterium.cridissent.count > 0 %>
            <div>
              <span class="orange"><%= pluralize(criterium.cridissent.count, "Concern") %></span>
                (<span class="show-objections gray" id="show-objections-<%=criterium.id%>">View</span> | 

              <% if criterium.cridissent.find_by(user: @user) %>
                <%= link_to assent_criteria_path(:criterium_id => criterium.id), :method => "post" do %>  <span class="cridissent-count gray" href="#" aria-label="Remove concern" tabindex="0">
                  Remove)
                </span>
                <% end %>
              <% else %>
                <span class="cridissent-count submit-concern gray" id="submit-concern-<%=criterium.id%>">Add)</span>
              <% end %>

              <% if criterium.crialt.count > 0 %>
              <br>
                <span>
                  <span class="purple"><%= pluralize(criterium.crialt.count, "Alternative") %></span>
                    (<span class="crialt-button gray" id="open-crialt-<%=criterium.id%>">View</span> | 
                    <span class="crialt-button gray" id="add-crialt-<%=criterium.id%>">Add</span>)
                </span>
              <% else %>
                <br>
                <span class="crialt-button gray" id="add-crialt-<%=criterium.id%>">+ suggest alternative</span>
              <% end %>

            </div>
          <% else %>

            <div class="dissent-stuff">
              <!-- Objections -->
              <% if criterium.cridissent.find_by(user: @user) %>
                  <%= link_to assent_criteria_path(:criterium_id => criterium.id), :method => "post" do %>   
                    <span class="cridissent-count gray" href="#" aria-label="Remove concern" tabindex="0">
                      â€“ retract concern
                    </span>
                  <% end %>
              <% else %>
                  <span class="cridissent-count submit-concern gray" id="submit-concern-<%=criterium.id%>" href="#" aria-label="Lodge a concern" tabindex="0">
                    + add concern
                  </span>    

              <% end %>
            </div>
          
          <% end %>

        </div>
      </div>


      <!-- If there's a facilitator -->
      <% if criterium.problem.facilitator_id && logged_in? %>
        <!-- If you are the facilitator -->
        <% if criterium.problem.facilitator_id == @user.id %>
            <div class="criteria-sponsorship">
              <%if criterium.user.include?(@user)%>
                <%= link_to unsponsor_criteria_path(:criterium_id => criterium.id), :method => "post" do %>
                  <span class="crisupport-count gray yellow-background small-button" href="#" tabindex="0">
                    <i class="fas fa-times gray"></i>
                    Remove
                  </span>
                <% end %>
              <%else%>
                <%= link_to sponsor_criteria_path(:criterium_id => criterium.id), :method => "post" do %>
                  <span class="crisupport-count gray small-button green-background" href="#" tabindex="0">
                    <i class="fas fa-plus gray"></i>
                    Add to criteria
                  </span>
                <% end %>

                <!-- &nbsp; -->

                <div>
                <%= link_to destroy_criterium_path(:id => criterium.id), :method => "delete", data: { confirm: 'Are you sure you want to delete this criterion?' } do %>
                  <span class="crisupport-count gray small-button red-background" href="#" tabindex="0">
                    <i class="fas fa-minus-circle gray"></i>
                    Delete
                  </span>
                <% end %>
                </div>

              <% end %>
            </div>
        <!-- If you aren't the facilitator -->
        <%else%>
        <%end%>
      <%end%>
    </div>

  </div>

  <div class="objection-popup" id="objection-<%=criterium.id%>">
    <div class="objection-inner">
      <i class="fas fa-times close-window"></i>
      <h2>What is your concern with the criterion "<%=criterium.title%>"?</h2>

      <div class="criterion-objection-input">
      <%= form_for(criterium.cridissent.new, :url => dissent_criteria_path, remote: true) do |form| %>
        <!-- <div class="dissent-instructions">I cannot support a proposal that meets this criterion because</div> -->
        <%= form.hidden_field :criterium_id %>
        <div class="dissent-title"><%= form.text_area :title%></div>
        <!-- <div class="submit-dissent"> -->
        <div>
          <%= form.submit "Submit", :class => "button" %>
        </div>
      <% end %>
      </div>
    </div>
  </div>

  <div class="objection-popup" id="objection-list-<%=criterium.id%>">
    <div class="objection-list-inner">
      <i class="fas fa-times close-window"></i>
      <h2>Concerns about "<%=criterium.title%>"</h2>
      <ul><% criterium.cridissent.each do |dissent| %>
      <%if dissent.user%>
        <li>
          <strong><%= link_to(dissent.user.name, dissent.user) %></strong>:
          <% if dissent.title.length > 0 %>
            "<%= dissent.title %>"
          <% else %>
            is concerned about this criterion
          <%end%>
        </li>
      <%end%>
    <% end %></ul>
    </div>
  </div>

  <div class="objection-list" id="crialt-<%=criterium.id%>" style="display: none;">
    <div class="objection-list-inner">
      <i class="fas fa-times close-window"></i>
      <h2>Suggest an alternative for "<%=criterium.title%>"</h2>

      <ol>
        <input placeholder="Suggest a new criterion" style="width: 295px">&nbsp;<button>Suggest</button>

        <% criterium.problem.criterium.each do |alt| %>
          <% unless alt.id==criterium.id || criterium.crialt.select{|x| x["alternative"].to_i == alt.id}.count > 0%>
              <li>
                <div><strong><%= alt.title %></strong>
                <% if alt.cridissent.count > 0 %>
                  (<%= pluralize(alt.cridissent.count, 'concern')%>)
                <% end %></div>
                &nbsp;<%= link_to "Suggest", alt_criterium_path(:from => criterium.id, :to=> alt.id), :class => "suggest-link", :method => "post" %>
              </li>
          <% end %>
        <% end %>
      </ol>
    </div>
  </div>

  <div class="objection-list" id="crialt-list-<%=criterium.id%>" style="display: none;">
    <div class="objection-list-inner">
      <i class="fas fa-times close-window"></i>
      <h2>Suggested alternatives for "<%=criterium.title%>"</h2>

      <ol>
        <% criterium.crialt.order("transferred_user_count DESC").each do |suggestion| %>
            <li>
                <div><strong><%= Criterium.find(suggestion.alternative).title %></strong>
                <% if !criterium.problem.facilitator_id %>
                  (<%= suggestion.transferred_user_count %> <i class="fas fa-sync-alt"></i>) 
                <% end %></div>
              <% if criterium.user.include?(@user) %>
                &nbsp;<%= link_to "Switch to this", accept_alt_path(:crialt => suggestion.id), :class => "transfer-link", :method => "post"%>
              <% end %>
            </li>
        <%end%>
      </ol>
    </div>
  </div>

<%end%>

<script type="text/javascript">
  $('#submit-concern-<%=criterium.id%>').click( function() {
    $('#objection-<%=criterium.id%>').show()
  })

  $('#objection-<%=criterium.id%>').find('.close-window').click(function(){
    $('#objection-<%=criterium.id%>').hide()
  })

  $('#show-objections-<%=criterium.id%>').click( function() {
    $('#objection-list-<%=criterium.id%>').show()
  })

  $('#objection-list-<%=criterium.id%>').find('.close-window').click(function(){
    $('#objection-list-<%=criterium.id%>').hide()
  })

  $('#add-crialt-<%=criterium.id%>').click( function() {
    $('#crialt-<%=criterium.id%>').show()
  })

  $('#crialt-<%=criterium.id%>').find('.close-window').click(function(){
    $('#crialt-<%=criterium.id%>').hide()
  })

  $('#open-crialt-<%=criterium.id%>').click( function() {
    $('#crialt-list-<%=criterium.id%>').show()
  })

  $('#crialt-list-<%=criterium.id%>').find('.close-window').click(function(){
    $('#crialt-list-<%=criterium.id%>').hide()
  })
</script>