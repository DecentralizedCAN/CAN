<div id="main-feed">

	<% if Group.all.length > 0 %>
	<div id="group_nav">
		Group:  

	  <% if (!params[:group] || params[:group] == '0') %><span class="current_group"><% else %><span><% end %>
  	<%= link_to "None", url_for(request.params.merge(:group => '0')) %></span>


	  <% Group.all.each do |group| %>
	  	<% if params[:group].to_i == group.id %>
	  	<span class="current_group">
  		<% else %>
  		<span><% end %>
  		<%= link_to group.name, url_for(request.params.merge(:group => group.id)) %></span>
	  <% end %>

	  <%= link_to '+', new_group_path %>
	</div>
	<% end %>

	<!-- <i class="fas fa-sort"></i> -->
	Sort:
    <%= link_to url_for(request.params.merge(:sort => 'popular')) do %>
	  <!-- <i class="fas fa-sort"></i> -->
    <% if params[:sort] != 'recent' %>
    	<span class="underline-permanent">popular</span>
    <% else %>
    	popular
    <% end %>
  <% end %>
	  |
	<%= link_to url_for(request.params.merge(:sort => 'recent')) do %>
	  <!-- <i class="fas fa-sort"></i> -->
    <% if params[:sort] != 'recent' %>
    	recent
    <% else %>
    	<span class="underline-permanent">recent</span>
    <% end %>
  <% end %>


	<div class="flex-container">
		<ol class="new-posts">
	  <% @posts.each do |post| %>
			<% #if post.upvotes.count > 0 %>
			<% if true #(params[:group] == 'main' || params[:group].to_i == post.group_id) %>
				<% if post.link_id %>
					<li class="post-outer">
					<%= render(:partial => 'post-stuff', :locals => {:post => post})%>
  				<%= link_to goal_path(:goal_id => Goal.find(post.link.child.hashid), :view => "public") do %>
	          <div class="issue">
	          	<div class="goal-title">
	          			<span class="referenced-goal">
	          				<%= Goal.find(post.link.parent.id).title %>
          				</span>
          				<i class="fas fa-link" style="color: #dd72ff"></i>
	          			<span class="underline">
        					<span class="referenced-goal"> 
        						<%= Goal.find(post.link.child.id).title %>
      						</span></span>
      						<span class="feed-label">Goal</span>
                  
                  <div class="post-signature">
                    <%= time_ago_in_words(post.created_at) %> ago
                    • by <em><%= 
                    begin 
                      post.upvotes.first.user.name
                    rescue 
                    end  %></em>
                  </div>
	          	</div>

		            <div class="issue-info">
		              <!-- <br> -->

		              <div>
		                <!-- <i class="fas fa-handshake"></i> -->
		                <%= Link.find(post.link_id).user.count %> adopters
		              </div>

	            	</div>
						</div>
					<% end %>
					</li>

				<% elsif post.activity %>
			  	
					<% if (post.activity.deadline && post.activity.deadline > @current_time) || (post.activity.expiration && post.activity.expiration > @current_time) || (!post.activity.deadline && !post.activity.expiration) %>
						<li class="post-outer">
							<%= render(:partial => 'post-stuff', :locals => {:post => post})%>

							<%= link_to action_path(post.activity.hashid) do %>
						  <div class="proposal">
								<%= render(:partial => 'activities/activity', :locals => {:activity => post.activity})%>
						  </div>
							<% end %>
						</li>
					<% end %>
				<% elsif post.problem %>

				<li class="post-outer home-item home-item-underlined">
				<%= render(:partial => 'post-stuff', :locals => {:post => post})%>
				<%= link_to issue_path(post.problem) do %>
	        <% #if post.problem.user.count > 0 %>
	          <div class="issue">
	            <div class="issue-title"><span class="underline"><%= post.problem.title %></span> <span class="feed-label">Solver</span>
		              <div class="post-signature">
		                <!-- <i class="fas fa-calendar"></i> -->
		                <%= time_ago_in_words(post.problem.created_at) %> ago
          					• by
          					<em><%= 
				            begin 
				              User.find(post.problem.creator).name
				            rescue 
				            end  %></em>
		              </div>
	            </div>

					      <% if post.problem.goal %>
					        <div class="proposal-activity-description">
					          <i class="fas fa-link"></i>
					          Attached to goal <strong>"<%= post.problem.goal.title %>"</strong>
					        </div>
					      <% end %>

					      <% problem = post.problem %>

                <% if false %>
                  <% if problem.facilitator_id && problem.facilitator_id != current_user.id && problem.facilitator_id > 0 %>
                    <div class="facilitator">
                        <i class="fas fa-user-shield"></i>
                        <% facilitator = User.find(problem.facilitator_id) %>
                        Facilitator: 
                        <strong><%= User.find(problem.facilitator_id).name %></strong>
                    </div>
                  <% elsif problem.facilitator_id && problem.facilitator_id == current_user.id %>
                    <div class="facilitating">
                      <i class="fas fa-star"></i>
                      Facilitating
                    </div>
                  <% else %>
                    <div class="facilitator">
                      <i class="fas fa-user-shield"></i>
                      Distributed facilitation
                    </div>
                  <% end %>
                <% end %>


                  <div class="issue-info">
                    <div id="open-collaborators">
                      Collaborators<br>
                      <div><i class="fas fa-users"></i>
                      <strong><%= problem.user.count %></strong></div>
                    </div>
                    <div>
                      Proposals<br>
                      <div><i class="fas fa-file"></i>
                      <strong><%= problem.solution.count %></strong></div>
                    </div>
                    <div>
                      Criteria<br>
                      <div><i class="fas fa-clipboard-check"></i>
                      <strong><%= problem.criterium.joins(:user).group("criteria.id").count.count %></strong></div>
                    </div>

		            <!-- <div class="issue-info"> -->

<!-- 		              <br>
		              <div>
		                <i class="fas fa-handshake"></i>
		                <%= post.problem.user.count %> collaborators
		              </div>
		              <div>
		                <i class="fas fa-clipboard-list"></i>
		                <%= post.problem.criterium.count %> criteria
		              </div>
		              <div>
		                <i class="fas fa-comment-alt"></i>
		                <%= pluralize(post.problem.solution.count, "proposal") %>
		              </div> -->
		  

		            </div>
		          </div>

	      <% end %>
	    	</li>


				<% elsif post.discussion %>
					<li class="post-outer">			
					<%= render(:partial => 'post-stuff', :locals => {:post => post})%>
					<%= link_to discussion_path(post.discussion) do %>
	          <div class="discussion">

							<div class="discussion-title">
				      	<% if post.discussion.goal %>
				          <span class="referenced-goal"><strong>"<%= post.discussion.goal.title %>"</strong></span>
				          <i class="fas fa-arrow-right"></i>
				      <% end %>
							<span class="underline" style="text-shadow: 0px 0px 12px #81c4ff"><%= post.discussion.title %></span>
							<span class="feed-label">Discussion</span>
              <div class="post-signature">
                  <!-- <i class="fas fa-calendar"></i> -->
                  <%= time_ago_in_words(post.discussion.created_at) %> ago
                  • by
                  <em><%= 
                  begin 
                    User.find(post.discussion.creator).name
                  rescue 
                  end  %></em>
                </div>
              </div>

							<div class="issue-info">
	              
	              <div>
	                Comments<br>
                  <div><i class="fas fa-comment-dots"></i>
                  <%= post.discussion.comment.count %></div>
	              </div>
	            </div>
						</div>
		      <% end %>
		    </li>
				<% end %>

				<!-- <hr> -->

		<% end %>
		<% end %>
		
		<span id="paginate_solutions"><%= will_paginate @posts %></span>

		</ol>

		<ol class="side-card">

			<% if Group.all.length > 0 && (params[:group] && params[:group] != '0') %>
			  <div class="card-item">
					<% @group = Group.find(params[:group]) %>
					<h3><%= @group.name %> members
			    <% if params[:group].to_i == @group.id && @group.user.include?(current_user) %>
			      (<%= link_to "Leave", leave_group_path(:group_id => @group.id), :method => "post" %>)
			    <% elsif params[:group].to_i == @group.id %>
			      (<%= link_to "join", join_group_path(:group_id => @group.id), :method => "post" %>)
			    <% end %></h3>
					<ol style="padding-left: 20px;">
					<% Group.find(params[:group]).user.each do |user| %>
						<li><%= user.name %></li>
					<% end %>
					</ol>
				</div>
			<% end %>

		  <!-- <div id="post-something"> 
  			<%= link_to 'New Post', new_discussion_path if logged_in? %>
		  </div> -->

			<% if logged_in? && @notifications.length > 0 %>
		  <div class="card-item">

		  	<div class="flex-container">
		  		<h2>Notifications</h2>
		  		<%= link_to "view all", notifications_path, :id => "all-notifications" %>
		  	</div>

				<ol id="notifications">
				<% @notifications.each do |notification| %>
				  <%= link_to notification_redirect_path(:notification_id => notification.id) do %>
      			<li class="unread" >
							<%= notification.details %>
						</li>
				  <% end %>
				<% end %>
				</ol>

			</div>
	  	<% end %>

      <%= render(:partial => 'static/commitments-mini') if logged_in? && !Setting.find(14).state %>

		</ol>
	</div>

</div>

<br><br>

<script type="text/javascript">
	<% if params[:group] %>
		localStorage.setItem('dcan-group', <%= params[:group] %>);
	<% end %>
</script>